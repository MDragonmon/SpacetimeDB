<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <ItemGroup>
    <NativeLibrary Include="$(MSBuildThisFileDirectory)..\bindings.c" />
  </ItemGroup>

  <Target Name="RemoveWasmComponents" BeforeTargets="_WasmWriteRspForLinking">
    <ItemGroup>
      <_WasmLinkStepArgs Remove="-Wl,--component-type,&quot;$([MSBuild]::NormalizePath('$(MicrosoftNetCoreAppRuntimePackRidNativeDir)', 'WasiHttpWorld_component_type.wit').Replace('\','/'))&quot;"/>
      <_WasmLinkStepArgs Include="-fuse-ld=lld" />
    </ItemGroup>
  </Target>

  <!-- Auto-download WASI SDK on the first run. -->
  <!-- Adapted from https://github.com/dotnet/dotnet-wasi-sdk/blob/2dbb00c779180873d3ed985e59e431f56404d8da/src/Wasi.Sdk/build/Wasi.Sdk.targets#L245-L262 -->
  <!-- Executes before the errors in https://github.com/dotnet/runtime/blob/57fd56a99d4c97ac2f95fe84640f2a3f653f4dd7/src/mono/wasi/build/WasiApp.Native.targets#L41-L50. -->
  <!-- TODO: remove when https://github.com/dotnet/runtime/issues/82788 is resolved. -->
  <Target Name="ObtainWasiSdk" BeforeTargets="_SetupWasiSdk;CheckWasmSdks">
    <PropertyGroup>
      <WasiSdkVersion>24</WasiSdkVersion>

      <WasiSdkDownloadTempFile>$([System.IO.Path]::Combine($(IntermediateOutputPath), "wasi-sdk.$(WasiSdkVersion).tar.gz"))</WasiSdkDownloadTempFile>

      <WasiSdkArch Condition="$([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture) == X64">x86_64</WasiSdkArch>
      <WasiSdkArch Condition="$([System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture) == Arm64">arm64</WasiSdkArch>

      <WasiSdkOS Condition="$([MSBuild]::IsOSPlatform('Windows'))">windows</WasiSdkOS>
      <WasiSdkOS Condition="$([MSBuild]::IsOSPlatform('Linux'))">linux</WasiSdkOS>
      <WasiSdkOS Condition="$([MSBuild]::IsOSPlatform('OSX'))">macos</WasiSdkOS>

      <WasiSdkUrl>https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-$(WasiSdkVersion)/wasi-sdk-$(WasiSdkVersion).0-$(WasiSdkArch)-$(WasiSdkOS).tar.gz</WasiSdkUrl>

      <WasiSdkRoot>$([System.IO.Path]::Combine($([System.Environment]::GetFolderPath(SpecialFolder.UserProfile)), '.wasi-sdk', "wasi-sdk-$(WasiSdkVersion)"))</WasiSdkRoot>
      <WASI_SDK_PATH>$(WasiSdkRoot)/</WASI_SDK_PATH>
      <WasiSysRoot>$([System.IO.Path]::Combine($(WasiSdkRoot), 'share', 'wasi-sysroot'))</WasiSysRoot>
      <WasiSdkBinPath>$([System.IO.Path]::Combine($(WasiSdkRoot), 'bin'))</WasiSdkBinPath>
      <WasiClang>$([System.IO.Path]::Combine($(WasiSdkBinPath), 'clang'))</WasiClang>
      <WasiClang Condition="$([MSBuild]::IsOSPlatform('Windows'))">$(WasiClang).exe</WasiClang>
    </PropertyGroup>

    <DownloadFile
            SourceUrl="$(WasiSdkUrl)"
            DestinationFolder="$(IntermediateOutputPath)"
            DestinationFileName="$([System.IO.Path]::GetFileName('$(WasiSdkDownloadTempFile)'))"
            Condition="!Exists('$(WasiClang)')" />

    <Message Importance="high" Text="Extracting $(WasiSdkDownloadTempFile) to $(WasiSdkRoot)..." Condition="!Exists('$(WasiClang)')" />
    <MakeDir Directories="$(WasiSdkRoot)" />
    <!-- Windows 10+ has tar built in, so this should work cross-platform -->
    <Exec Command="tar -xf &quot;$(WasiSdkDownloadTempFile)&quot; -C &quot;$(WasiSdkRoot)&quot; --strip-components=1" Condition="!Exists('$(WasiClang)')" />

    <!-- For .NET 9: https://github.com/dotnet/runtime/blob/74b3518d14be43b77598bcd17c442120399890de/src/mono/mono.proj#L331C5-L331C69 -->
    <Touch Files="$(WasiSdkRoot)/VERSION$(WasiSdkVersion)" AlwaysCreate="true" />
  </Target>

</Project>
